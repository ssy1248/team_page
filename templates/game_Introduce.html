<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게임 소개 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .myTitle {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQoAAAC+CAMAAAD6ObEsAAAAElBMVEXH5K7I5a/M5rrQ6bvH5a3N5rief+IMAAAA3klEQVR4nO3Yyw6CMBRFURT5/182YXBMROVRHkLXGjftvZsZzX2gfdeNH2knXDPhyNxrut6EgYdnhi81p/boHT3Ff7h9cvRQx5DiRYqQIqQIKUKKkCKkCClCipAipAgpQoqQIqSIC6UoXeGiKea71F+sshRfAp3TyAeuMsWKFj63284LZpNCiupTNBvUWPjWbgsXkSJWS/Hryo13WMkGKc5KiqgjxaTJq0gxb0kppJBCCimOHgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIo8AU8xClt089oxAAAAAElFTkSuQmCC');
            background-position: center;
            background-size: cover;

            height: 250px;
            color: black;

            /*박스 안의 내용을 정렬할땐 아래 4가지를 조절하면 된다.*/
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .buttonGroup {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .buttonGroup button {
            margin: 10px 10px 10px 10px;
            border: 1px solid green;
            /* Green border */
            color: black;

            padding: 10px 24px;
            /* Some padding */
            cursor: pointer;
            /* Pointer/hand icon */
            float: left;
            /* Float the buttons side by side */
        }

        .myPostingBox {
            width: 300px;
            margin: 20px auto 20px auto;

            border: 1px solid white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .form-floating>input {
            background-color: transparent;
            color: black;
        }

        .myPostingBox>button {
            width: 100%;
        }

        .card {
            display: flex;
            /* Flexbox로 설정 */
            outline: auto;
            margin: 20px;
            /* 카드 간격 */
        }

        .card-body {
            display: flex;
            flex-direction: column;
            /* 세로 방향으로 정렬 */
            align-items: center;
            /* 가운데 정렬 */
            justify-content: center;
            padding: 10px;
            /* 여백 추가 */
            color: black;
            /* 텍스트 색상 */
        }

        .button-body {
            display: flex;
            flex-direction: column;
            /* 세로 방향으로 정렬 */
            align-items: center;
            /* 가운데 정렬 */
            justify-content: center;
            padding: 10px;
            /* 여백 추가 */
        }

        /* 선택된 카드에 빨간 테두리 */
        .card.selected {
            outline: 2px solid red;
        }

        /*모달 팝업 영역 스타일링*/
        .modal {
            /*팝업 배경*/
            display: none;
            /*평소에는 보이지 않도록*/
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal .modal_popup {
            /*팝업*/
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: #ffffff;
            border-radius: 20px;
        }

        .modal .modal_popup .close_btn {
            display: block;
            padding: 10px 20px;
            background-color: rgb(116, 0, 0);
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .modal.on {
            display: block;
        }
    </style>
</head>

<body>
    <div class="myTitle">
        <h1>게임 소개</h1>
    </div>

    <div class="buttonGroup">
        <button type="button" id="addGameButton">게임 올리기</button>
        <button type="button" id="deleteGameButton">게임 삭제</button>
        <button type="button" id="likeSortButton">좋아요 순으로 정렬</button>
        <button type="button" id="recentSortButton">최신 순으로 정렬</button>
    </div>

    

    <div class="modal">
        <div class="modal_popup">
            <h3>게임 등록</h3>
            <div class="myPostingBox" id="postingbox">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="image" placeholder="Game Image">
                    <label for="floatingInput">게임 이미지</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="title" placeholder="게임 이름">
                    <label for="floatingInput">게임 이름</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="comment" placeholder="게임 간단 소개">
                    <label for="floatingInput">게임 간단 소개</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="people" placeholder="추천인">
                    <label for="floatingInput">추천인</label>
                </div>
                <button id="postingbtn" type="button" class="btn btn-primary">올리기</button>
            </div>
            <button type="button" id="close_btn">닫기</button>
        </div>
    </div>

    <div id="card" class="row row-cols-1 row-cols-md-1 g-8">

    </div>

    <script type="module">
        // 좋아요, 싫어요 카운트를 저장할 객체
        let likeCounts = {};
        let dislikeCounts = {};

        // 임시 firebase 
        // Firebase SDK 모듈 import (중복 제거)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebase 구성 정보 설정
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCsyFszrRmQewSW-2lTWW2bYprwm2OgGqQ",
            authDomain: "sparta-4579e.firebaseapp.com",
            projectId: "sparta-4579e",
            storageBucket: "sparta-4579e.appspot.com",
            messagingSenderId: "949246567615",
            appId: "1:949246567615:web:0bba8c03086cd6bb5ed20a",
            measurementId: "G-3QZH67YDVF"
        };

        // Firebase 인스턴스 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 카드 선택 기능 - https://velog.io/@leejpsd/document.on%EA%B3%BC-document.ready
        //https://developer.mozilla.org/ko/docs/Learn/CSS/Building_blocks/Selectors/Attribute_selectors
        $(document).on('click', '.card', function (event) {
            if (!$(event.target).is('button') && !$(event.target).is('img')) { // 클릭된 요소가 버튼이 아닌 경우에만 실행
                //selected 클래스 추가
                $(this).toggleClass('selected');
                //카드가 선택이 되면 아웃라인을 설정 아닐 시 기본 아웃라인을 보여줌
                $(this).css('outline', $(this).hasClass('selected') ? '2px solid red' : 'auto');
            }
        });

        // 좋아요 버튼 클릭 시 카운트 증가
        $(document).on('click', '.goodbtn', async function () {
            // 카드 ID를 기반으로 좋아요 카운트를 관리 -> https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes(참고)
            //https://www.codeconcisely.com/posts/javascript-data-attributes/(참고)
            const cardId = $(this).closest('.card').data('id'); // 클릭한 카드의 data-id 추출
            //|| 사용한 이유는 likeCounts[cardId]가 초기에 undefined 이면 오류가 나오기에 undefined일시 초기값을 0으로 설정
            likeCounts[cardId] = (likeCounts[cardId] || 0) + 1; // 좋아요 카운트 증가
            $(this).text(`좋아요 (${likeCounts[cardId]})`); // 버튼에 카운트 표시
            await updateLikeCount(cardId, likeCounts[cardId]); // Firestore에 업데이트
        });

        // 싫어요 버튼 클릭 시 카운트 증가
        $(document).on('click', '.badbtn', async function () {
            const cardId = $(this).closest('.card').data('id'); // 클릭한 카드의 data-id 추출
            dislikeCounts[cardId] = (dislikeCounts[cardId] || 0) + 1; // 싫어요 카운트 증가
            $(this).text(`싫어요 (${dislikeCounts[cardId]})`); // 버튼에 카운트 표시
            await updateDislikeCount(cardId, dislikeCounts[cardId]); // Firestore에 업데이트
        });

        // 게임 삭제 버튼 클릭 시 선택된 카드 삭제
        $('#deleteGameButton').click(function () {
            //삭제 시 firebase에서도 삭제 - 추후 추가
            $('.card.selected').remove(); // 선택된 카드만 삭제
        });

        // Firestore에 좋아요 카운트 업데이트 함수
        //https://firebase.google.com/docs/database/admin/save-data?hl=ko#node.js 참고
        async function updateLikeCount(cardId, newCount) {
            const docRef = doc(db, "games", cardId);  // doc 함수로 특정 문서를 지정
            await updateDoc(docRef, { likeCount: newCount });
        }

        // Firestore에 싫어요 카운트 업데이트 함수
        async function updateDislikeCount(cardId, newCount) {
            const docRef = doc(db, "games", cardId);  // doc 함수로 특정 문서를 지정
            await updateDoc(docRef, { dislikeCount: newCount });
        }

        //좋아요 순으로 정렬
        $('#likeSortButton').click(async function () {
            // Firestore에서 likeCount 기준으로 내림차순 정렬하여 데이터 가져오기
            //https://firebase.google.com/docs/firestore?hl=ko(참고)
            const q = query(collection(db, "games"), orderBy("likeCount", "desc"));
            const querySnapshot = await getDocs(q);

            // 화면의 카드 요소 초기화
            $('#card').empty();

            // Firestore에서 가져온 정렬된 데이터를 화면에 추가
            querySnapshot.forEach((doc) => {
                let row = doc.data();
                let docId = doc.id;

                // Firestore의 Timestamp를 Date 형식으로 변환 / 기존에 올라간 
                let createdAt = row.createdAt ? row.createdAt.toDate().toLocaleDateString() : new Date("2024-10-29").toLocaleDateString();

                //최신 정렬과 같이 likecount가 값이 있어야 정렬이 되는데 처음 좋아요를 받기 전까지 firebase에서 likeCount가 안 생겨서 강제로 생성해 놓은 상태
                let card = `
                    <div class="col">
                        <div class="card" data-id="${docId}" style="width: auto; height: auto;">
                            <img src="${row.image}"
                                class="card-img-top" alt="..." style="width: 50%; height: auto;">
                            <div class="card-body">
                                <h3 class="card-title">게임 이름 : ${row.title}</h3>
                                <p class="card-text">게임 소개 : ${row.comment}</p>
                                <p class="card-people">추천인 : ${row.people}</p>
                                <p class="card-date">등록 날짜 : ${createdAt}</p>
                            </div>
                            <div class="button-body">
                                <button type="button" class="btn btn-danger goodbtn" style="height: 60px; width: 200px;">좋아요 (${row.likeCount || 0})</button>
                                <button type="button" class="btn btn-primary badbtn" style="height: 60px; width: 200px;">싫어요 (${row.dislikeCount || 0})</button>
                            </div>
                        </div>
                    </div>`;
                $('#card').append(card);
            });
        });

        //최신 순으로 정렬 - 등록 날짜 순으로 정렬
        $('#recentSortButton').click(async function () {
            const q = query(collection(db, "games"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            $('#card').empty();

            // Firestore에서 가져온 정렬된 데이터를 화면에 추가
            querySnapshot.forEach((doc) => {
                let row = doc.data();
                let docId = doc.id;

                // Firestore의 Timestamp를 Date 형식으로 변환 / 디폴트 값을 2024-10-29로 설정했으나 정렬을 눌렀을 때 firebase에 값이 없는 상황이 생김 그래서 firebase에서 강제로 값을 넣어놓은 상태
                let createdAt = row.createdAt ? row.createdAt.toDate().toLocaleDateString() : "2024-10-29";

                let card = `
                    <div class="col">
                        <div class="card" data-id="${docId}" style="width: auto; height: auto;">
                            <img src="${row.image}"
                                class="card-img-top" alt="..." style="width: 50%; height: auto;">
                            <div class="card-body">
                                <h3 class="card-title">게임 이름 : ${row.title}</h3>
                                <p class="card-text">게임 소개 : ${row.comment}</p>
                                <p class="card-people">추천인 : ${row.people}</p>
                                <p class="card-date">등록 날짜 : ${createdAt}</p>
                            </div>
                            <div class="button-body">
                                <button type="button" class="btn btn-danger goodbtn" style="height: 60px; width: 200px;">좋아요 (${row.likeCount || 0})</button>
                                <button type="button" class="btn btn-primary badbtn" style="height: 60px; width: 200px;">싫어요 (${row.dislikeCount || 0})</button>
                            </div>
                        </div>
                    </div>`;
                $('#card').append(card);
            });
        });

        //firebase 에 게임 추가 데이터 값 저장
        $('#postingbtn').click(async function () {
            let image = $('#image').val(); //게임 이미지
            let title = $('#title').val(); //게임 이름
            let comment = $('#comment').val(); //게임 소개
            let people = $('#people').val(); //게임 추천인

            let doc =
            {
                'image': image,
                'title': title,
                'comment': comment,
                'people': people,
                createdAt: serverTimestamp(),
                likeCount : 0,
            };
            await addDoc(collection(db, "games"), doc);
            alert('저장 완료!');
            window.location.reload();
        })

        // 모달 사용을 위한 버튼 & 팝업 창 찾기
        const modal = document.querySelector('.modal');
        const modalOpen = document.querySelector('.addGameButton');
        const modalClose = document.querySelector('.close_btn');

        //모달을 이용해서
        //https://velog.io/@seungmimi/javascript%EB%AA%A8%EB%8B%AC-%ED%8C%9D%EC%97%85-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0
        $('#addGameButton').click(async function () {
            modal.classList.add('on');
            $('#postingbox').toggle();
        });

        $('#close_btn').click(function(){
            modal.classList.remove('on');
        });

        //게임 이미지 클릭 하면 링크
        $(document).on('click', '.card-img-top', function () {
            // 클릭한 카드에서 제목을 추출
            let gameTitle = $(this).closest('.card').find('.card-title').text().replace("게임 이름 : ", "").trim();

            // Google 검색 URL 생성
            let searchUrl = `https://www.google.com/search?q=${encodeURIComponent(gameTitle)}`;

            // 새 창으로 링크 열기
            window.open(searchUrl, "_blank");
        });

        //db에 저장된 데이터 값 가져오기
        let docs = await getDocs(collection(db, "games"));
        docs.forEach(doc => {
            let row = doc.data();
            let docId = doc.id; // Firebase 문서 ID를 고유 ID로 사용

            // Firestore에서 가져온 likeCount와 dislikeCount 값을 화면에 적용
            likeCounts[docId] = row.likeCount || 0;
            dislikeCounts[docId] = row.dislikeCount || 0;

            // Firestore에서 등록 날짜 가져오기 및 변환
            let createdAt = row.createdAt ? row.createdAt.toDate().toLocaleDateString() : new Date("2024-10-29").toLocaleDateString();

            let image = row['image'];
            let title = row['title'];
            let comment = row['comment'];
            let people = row['people'];

            let card = `
            <div class="col">
                <div class="card" data-id="${docId}" style="width: auto; height: auto;">
                    <img src="${image}"
                        class="card-img-top" alt="..." style="width: 50%; height: auto;">
                    <div class="card-body">
                        <h3 class="card-title">게임 이름 : ${title}</h3>
                        <p class="card-text">게임 소개 : ${comment}</p>
                        <p class="card-people">추천인 : ${people}</p>
                        <p class="card-date">등록 날짜 : ${createdAt}</p>
                    </div>
                    <div class="button-body">
                        <button type="button" class="btn btn-danger goodbtn" style="height: 60px; width: 200px;">좋아요 ${likeCounts[docId]}</button>
                        <button type="button" class="btn btn-primary badbtn" style="height: 60px; width: 200px;">싫어요 ${dislikeCounts[docId]}</button>
                    </div>
                </div>
            </div>`
            $('#card').append(card);
        });
    </script>
</body>

</html>